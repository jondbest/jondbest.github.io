<html>
<head>
<script src="https://cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.js"></script>
<style>
html, body, #app {
  height: 100%;
}
body {
  background: #20262E;
  margin: 0;
}
#app {
  display: flex;
  transition: all 0.2s;
}
textarea {
  width: 92%;
  height: 92%;
  border: none;
  border-radius: .1rem;
  box-shadow: .1rem .1rem .5rem rgba(0,0,0,.1);
  resize: none;
  padding: .25rem .5rem;
  margin: auto;
}
.col {
  display: inline-flex;
  width: 50%;
}
</style>
<body>
  <div id="app">
    <div class="col">
      <textarea placeholder="paste some IBM RPG code here" v-model="input"></textarea>
    </div>
    <div class="col">
      <textarea v-model="output"></textarea>
    </div>
  </div>
  <script>
class RpgLine {
  constructor(rawText) {
    this.cmd = rawText.substr(35,5).trim(); // command
    this.f1 = this.vars(rawText.substr(25,10).trim()); // factor 1
    this.f2 = this.vars(rawText.substr(40,10).trim()); // factor 2
    this.result = this.reserved(rawText.substr(50,8).trim()); // result
    this.i1 = rawText.substr(58,9).trim(); // indicator 1
    this.i2 = rawText.substr(67,20).trim(); // indicator 2
  }
  get js() {
  	switch (this.cmd.toLowerCase()) {
      case 'klist':
      case 'kfld':
      case 'setll':{
      	return;
      }
    	case "movel":
    	case "move": {
      	return this.result + ' = ' + this.f2 + ';';
      }
    	case "z-add": {
      	return this.result + ' = ' + this.f2 + ';';
      }
    	case "add": {
      	return this.result + ' += ' + this.f2 + ';';
      }
    	case "z-sub": {
      	return this.result + ' = -(' + this.f2 + ');';
      }
    	case "sub": {
        if(this.f1) return this.result + ' = ' + this.f1 + ' - ' + this.f2 + ';';
        else return this.result + ' -= ' + this.f2 + ';';
      }
    	case "doueq": {
      	return 'while (' + this.f1 + ' !== ' + this.f2;
      }
    	case "doweq": {
      	return 'while (' + this.f1 + ' === ' + this.f2;
      }
    	case "ifeq": {
      	return 'if (' + this.f1 + ' === ' + this.f2;
      }
    	case "ifgt": {
      	return 'if (' + this.f1 + ' > ' + this.f2;
      }
    	case "ifge": {
      	return 'if (' + this.f1 + ' >= ' + this.f2;
      }
    	case "iflt": {
      	return 'if (' + this.f1 + ' < ' + this.f2;
      }
    	case "ifle": {
      	return 'if (' + this.f1 + ' <= ' + this.f2;
      }
    	case "andeq": {
      	return '&& ' + this.f1 + ' === ' + this.f2;
      }
    	case "andgt": {
      	return '&& ' + this.f1 + ' > ' + this.f2;
      }
    	case "andlt": {
      	return '&& ' + this.f1 + ' < ' + this.f2;
      }
    	case "oreq": {
      	return '|| ' + this.f1 + ' === ' + this.f2;
      }
    	case "orgt": {
      	return '|| ' + this.f1 + ' > ' + this.f2;
      }
    	case "orlt": {
      	return '|| ' + this.f1 + ' < ' + this.f2;
      }
    	case "exsr": {
      	return this.f2 + '();';
      }
    	case "begsr": {
      	return 'function ' + this.f1 + '() {';
      }
      case "endsr": {
        return '} /* end function */';
      }
      case "enddo": {
        return '} /* end while */';
      }
      case "endif": {
        return '} /* end if */';
      }
      default: {
        return (this.result?this.result + " = ":"") + this.cmd + "('"+this.f1+"','"+this.f2+"','"+this.i1+"','"+this.i2+"');";
      }
    }
  }
  vars(str) {
    return str.replace('*ZEROS','0').replace('*BLANKS',"''").replace('*IN','_index_').replace('*ON','_on_').replace('*OFF','_off_');
  }
  reserved(str) {
    return str.replace('#','_').replace('*','_');
  }
}
new Vue({
  el: "#app",
  data: {
    input: "",
    patterns: [
      {pattern: "(movel)\\s*(\\S+)\\s+(\\S+)", output: "\t$3 = $2 + substr($3,$2.length(),$3.length()-$2.length());"},
      {pattern: "(move)\\s*(\\S+)\\s+(\\S+)", output: "\t$3 = $2;"},
      {pattern: "(z-add)\\s*(\\S+)\\s+(\\S+)", output: "\t$3 = $2;"},
      {pattern: "(add)\\s*(\\S+)\\s+(\\S+)", output: "\t$3 += $2;"},
      {pattern: "(\\S+)\\s*(ifeq)\\s*(\\S+)", output: "if ($1 == $3"},
      {pattern: "(\\S+)\\s*(ifgt)\\s*(\\S+)", output: "if ($1 < $3"},
      {pattern: "(\\S+)\\s*(andeq)\\s*(\\S+)", output: "&& $1 == $3"},
      {pattern: "(\\S+)\\s*(andlt)\\s*(\\S+)", output: "&& $1 < $3"},
      {pattern: "(\\S+)\\s*(andgt)\\s*(\\S+)", output: "&& $1 > $3"},
      {pattern: "(\\S+)\\s*(oreq)\\s*(\\S+)", output: "|| $1 == $3"},
      {pattern: "(\\S+)\\s*(orlt)\\s*(\\S+)", output: "|| $1 < $3"},
      {pattern: "(\\S+)\\s*(orgt)\\s*(\\S+)", output: "|| $1 > $3"},
      {pattern: "(endif)", output: "}"},
      {pattern: "([*]blanks)", output: "\'\'"},
      {pattern: "([*]zeros)", output: "0"},
    ]
  },
  computed: {
  	output: function(){
      //if(this.input.includes('100      F')){
      	return this.parserpg(this.input);
      //} else {
      //	return this.rpg2js(this.input);
      //}
    }
  },
  methods: {
  	parserpg: function(input){
      var self = this;
      let output = [];
      let terminator = '';
      let lines = input.split('\n');
      lines.forEach(function(line){
      	if(line.substr(7,7).trim()==='C'){
          let fields = [];
          if(line.substr(14,1)==='*'){//comment
            if(line.substr(16,1)!=="-" && line.substr(15,10).trim().length>0){ output.push('/* '+line.substr(15,20).trim()+' */');
            }
          } else {
            //let js = self.rpg2js(line.substr(25,40));
            let js = new RpgLine(line).js;
            if(js){
              if(js.startsWith('if') || js.startsWith('while')) {
              	if(terminator) {
                  js = terminator + js;
                }
              	terminator = ') {';
              }
              else if(terminator && !js.startsWith('&&') && !js.startsWith('||')){
                js = terminator + js;
                terminator = '';
              }
              output.push(js);            
            }
          }
        }
      });
      return output.join('');//.join("\n").replace(/\s/g,'');
    },
    rpg2js: function(text){
      this.patterns.forEach(function(item){
        let rex = new RegExp(item.pattern, 'gi');
      	text = text.replace(rex, item.output)
      });
      return text.trim();
    },
  }
});
  </script>
</body>
</html>
